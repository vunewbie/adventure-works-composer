steps:
  # Step 0: Install required Python package(s) for deploy_to_composer.py
  - name: 'python:3.11'
    id: 'setup-python-env'
    entrypoint: bash
    args:
      - -c
      - |
        pip install --user google-cloud-storage==2.19.0
        cp -r /root/.local /workspace/.local

  # Step 1: Install packages(Only when needed)
  # - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  #   id: 'update-composer-packages'
  #   entrypoint: gcloud
  #   args:
  #     - composer
  #     - environments
  #     - update
  #     - ${_COMPOSER_ENVIRONMENT}
  #     - --location=${_COMPOSER_LOCATION}
  #     - --update-pypi-packages-from-file=requirements.txt

  # Step 2: Upload dags/ folder
  - name: 'python'
    entrypoint: python
    args:
      - "deploy_to_composer.py"
      - "--dags_directory=${_DAGS_DIRECTORY}"
      - "--composer_bucket=${_COMPOSER_BUCKET}"
    id: 'upload-dags'
    waitFor: ['setup-python-env']
    # waitFor: ['update-composer-packages']

  # Step 3: Upload plugins folders
  - name: 'python'
    entrypoint: python
    args:
      - "deploy_to_composer.py"
      - "--plugins_directory=${_PLUGINS_DIRECTORY}"
      - "--composer_bucket=${_COMPOSER_BUCKET}"
    id: 'upload-plugins'
    waitFor: ['setup-python-env']
    # waitFor: ['update-composer-packages']

options:
  logging: CLOUD_LOGGING_ONLY
  env:
    - 'SECRET_MANAGER_PROJECT_ID=${PROJECT_ID}'

substitutions:
  _DAGS_DIRECTORY: "dags/"
  _PLUGINS_DIRECTORY: "plugins/"
  _COMPOSER_BUCKET: "asia-southeast1-adventure-works-landing"
  _COMPOSER_ENVIRONMENT: "vunewbie-adventure-works"
  _COMPOSER_LOCATION: "asia-southeast1"
